(()=>{"use strict";var e,n={190:(e,n,t)=>{n.__esModule=!0;var o=t(968),s=t(712),r=t(923),i=function(){function e(){var e=this;this._onerror=function(e){var n=e.message,t=e.type;window.UNITY.socketError(t,n)},this._farwell=function(){e.socket.close()},this._hostChange=function(e){var n=e.host;window.host=n,window.UNITY.hostChange(n)},this._otherjoin=function(n){var t=n.id;e.peers[t]||(e.peers[t]=new s.default(e._socketsend,t,e._removePeer)),e.peers[t].createOffer(e._socketsend,t)},this._offer=function(n){var t=n.from,o=n.offer;e.peers[t]||(e.peers[t]=new s.default(e._socketsend,t,e._removePeer)),e.peers[t].handleOffer(e._socketsend,o)},this._answer=function(n){var t=n.from,o=n.answer;return e.peers[t].handleAnswer(o)},this._candidate=function(n){var t=n.from,o=n.candidate;e.peers[t]||(e.peers[t]=new s.default(e._socketsend,t,e._removePeer)),e.peers[t].handleCandidate(o)},this._removePeer=function(n){e.peers[n].close(),delete e.peers[n]};var n=/http(.*)/.exec(window.location.href)||["","ERROR.url-split.error"];this.socket=new r.default("ws"+n[1]),this.peers={},this.id=null,this.socket.on(o.SocketTypes.Join,this._otherjoin),this.socket.on(o.SocketTypes.HostChange,this._hostChange),this.socket.on(o.SocketTypes.Offer,this._offer),this.socket.on(o.SocketTypes.Answer,this._answer),this.socket.on(o.SocketTypes.Candidate,this._candidate),this.socket.on(o.SocketTypes.Farwell,this._farwell),this.socket.on(o.SocketTypes.Error+"-"+o.SocketErrorType.Host,this._onerror),this.socket.on(o.SocketTypes.Error+"-"+o.SocketErrorType.Join,this._onerror),this.socket.on(o.SocketTypes.Error+"-"+o.SocketErrorType.Room,this._onerror),this._socketsend=this.socket.send.bind(this.socket)}return e.prototype.send=function(e,n,t){return!!this.peers[e]&&(this.peers[e].send(n,t),!0)},e.prototype.broadcast=function(e,n){for(var t in this.peers)this.peers[t].send(e,n)},e.prototype.create=function(e,n){this.socket.send({type:o.SocketTypes.Create,room:e,password:n})},e.prototype.connect=function(e,n){this.socket.send({type:o.SocketTypes.Join,room:e,password:n})},e.prototype.terminateSocket=function(){this.socket.close()},e.prototype.terminate=function(){for(var e in this.socket.close(),this.peers)this._removePeer(e)},e.prototype.farwell=function(){this.socket.send({type:o.SocketTypes.Farwell})},e}();n.default=i},968:(e,n)=>{var t,o;n.__esModule=!0,n.SocketErrorType=n.SocketTypes=void 0,(o=n.SocketTypes||(n.SocketTypes={})).Create="room",o.Connect="connect",o.Join="join",o.JoinAnswer="join-answer",o.HostChange="host-change",o.Leave="leave",o.Error="error",o.Farwell="farwell",o.Candidate="candidate",o.Offer="offer",o.Answer="answer",(t=n.SocketErrorType||(n.SocketErrorType={})).Room="room",t.Join="join",t.Host="host"},712:(e,n,t)=>{n.__esModule=!0;var o=t(968),s=function(){function e(e,n,t,s){var r=this;void 0===s&&(s=["default"]);var i={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"}]},c=null;c=window.RTCPeerConnection?new RTCPeerConnection(i):new webkitRTCPeerConnection(i),this.connection=c,c.onicecandidate=function(n){n.candidate&&e({type:o.SocketTypes.Candidate,candidate:n.candidate,to:r.remote,from:window.peerID})},c.onicecandidateerror=function(e){return window.UNITY.error("ice",r.remote,e.errorText)},c.onconnectionstatechange=this.ConnectionStateChange.bind(this),c.ondatachannel=this.onDataChannel.bind(this),this.remote=n,this.channelSchema=s,this.channels={},this.close=t,this.kill=this.kill.bind(this)}return e.prototype.kill=function(){var e;for(var n in this.channels)(null===(e=this.channels[n].channel)||void 0===e?void 0:e.close)instanceof Function&&this.channels[n].channel.close();this.connection.close(),window.UNITY.disconnect(this.remote),this.close(this.remote)},e.prototype.ConnectionStateChange=function(){switch(window.UNITY.connectionUpdate(this.remote,this.connection.connectionState),this.connection.connectionState){case"closed":case"disconnected":case"failed":this.kill()}},e.prototype.onDataChannel=function(e){var n=e.channel;this.setUpChannel(n)},e.prototype.setUpChannel=function(e){var n=this;e.onmessage=function(t){return n.onChannelMessage(e.label,t)},e.onerror=function(t){return n.onChannelError(e.label,t)},e.onopen=function(){return n.onChannelOpen(e.label)},e.onclose=function(){return n.onChannelClose(e.label)},this.channels[e.label]={channel:e,queue:[]}},e.prototype.createChannel=function(e){var n=this.connection.createDataChannel(e);this.setUpChannel(n)},e.prototype.onChannelOpen=function(e){if(this.channels[e].queue.length>0){for(var n=0,t=this.channels[e].queue;n<t.length;n++){var o=t[n];this.send(o,e)}this.channels[e].queue=[]}window.UNITY.channelUpdate(e,"connected")},e.prototype.onChannelClose=function(e){window.UNITY.channelUpdate(e,"closed")},e.prototype.onChannelMessage=function(e,n){window.UNITY.message(e,this.remote,n.data)},e.prototype.onChannelError=function(e,n){window.UNITY.channelUpdate(e,"failed"),window.UNITY.error("channel",e,n.error.message)},e.prototype.createOffer=function(e,n){for(var t=this,s=0,r=this.channelSchema;s<r.length;s++){var i=r[s];this.createChannel(i)}return this.connection.createOffer().then((function(s){e({type:o.SocketTypes.Offer,to:n,from:window.peerID,offer:s}),t.connection.setLocalDescription(s)})).catch((function(e){console.error("offer-error",e),alert("Error when creating an offer")}))},e.prototype.handleOffer=function(e,n){var t=this;return this.connection.setRemoteDescription(new RTCSessionDescription(n)),this.connection.createAnswer().then((function(n){t.connection.setLocalDescription(n),e({type:o.SocketTypes.Answer,answer:n,to:t.remote,from:window.peerID})})).catch((function(e){window.UNITY.answerError(e)}))},e.prototype.handleAnswer=function(e){this.connection.setRemoteDescription(new RTCSessionDescription(e))},e.prototype.handleCandidate=function(e){this.connection.addIceCandidate(new RTCIceCandidate(e))},e.prototype.handleLeave=function(){this.connection.close(),this.connection.onicecandidate=null,this.close()},e.prototype.send=function(e,n){"string"==typeof n&&(n=[n]),n||(n=Object.keys(this.channels));for(var t=0,o=n;t<o.length;t++){var s=o[t];"open"===this.channels[s].channel.readyState?this.channels[s].channel.send(e):this.channels[s].queue.push(e)}},e}();n.default=s},923:(e,n,t)=>{n.__esModule=!0;var o=t(968),s=function(){function e(e){this.events={},this.ws=new WebSocket(e),this.ws.onmessage=this.message.bind(this)}return e.prototype.on=function(e,n){this.events[e]||(this.events[e]=new Array),this.events[e].push(n)},e.prototype.fire=function(e){for(var n=[],t=1;t<arguments.length;t++)n[t-1]=arguments[t];this.events[e]&&this.events[e].forEach((function(e){return e.apply(void 0,n)}))},e.prototype.send=function(e){var n=JSON.stringify(e);this.ws.send(n)},e.prototype.close=function(){this.send({type:o.SocketTypes.Leave}),this.ws&&this.ws.close()},e.prototype.error=function(e){this.fire(o.SocketTypes.Error+"-"+e.error,e)},e.prototype.message=function(e){var n=JSON.parse(e.data);switch(this.events[n.type]&&this.fire(n.type,n),n.type){case o.SocketTypes.Error:return this.error(n);case o.SocketTypes.Leave:var t=n.id;window.UNITY.disconnect(t);break;case o.SocketTypes.JoinAnswer:var s=n,r=(t=s.id,s.host);window.peerID=t,window.host=r,window.UNITY.hostChange(r),window.UNITY.setID(t)}},e}();n.default=s}},t={};e=function e(o){if(t[o])return t[o].exports;var s=t[o]={exports:{}};return n[o](s,s.exports,e),s.exports}(190),window.RTC=new e.default,window.UNITY={socketError:function(e,n){console.error("socker-error",e,n)},answerError:function(e){console.error("answer error",e)},connectionUpdate:function(e,n){console.log("state update",e,n)},message:function(e,n,t){console.log("new message from "+n+" on "+e+": "+t)},error:function(e,n,t){console.log("oh no, error!",n,e,t)},channelUpdate:function(e,n){console.log("new update for channel",e,n)},disconnect:function(e){console.log("peer disonnect",e)},hostChange:function(e){console.log("new host",e)},setID:function(e){console.log("ID set",e)}}})();