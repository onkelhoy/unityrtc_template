(()=>{"use strict";var e,n={190:(e,n,t)=>{n.__esModule=!0;var o=t(570),s=t(712),i=t(923),r=function(){function e(){var e=this,n=/http(.*)/.exec(window.location.href)||["","ERROR.url-split.error"];this.socket=new i.default("ws"+n[1]),this.peers={},this.id=null,this.socket.on("join",this._join.bind(this)),this.socket.on("success",this._success.bind(this)),this.socket.on("offer",this._offer.bind(this)),this.socket.on("answer",(function(n){var t=n.target,o=n.answer;return e.peers[t].handleAnswer(o)})),this.socket.on("candidate",(function(n){var t=n.target,o=n.candidate;return e.peers[t].handleCandidate(o)})),this._socketsend=this.socket.send.bind(this.socket)}return e.prototype._join=function(e){var n=e.target;this.peers[n]||(this.peers[n]=new s.default(this._socketsend,n,this.leave.bind(this))),this.peers[n].createOffer(this._socketsend,this.id)},e.prototype._offer=function(e){var n=e.target,t=e.offer;this.peers[n]||(this.peers[n]=new s.default(this._socketsend,n,this.leave.bind(this))),this.peers[n].handleOffer(this._socketsend,t)},e.prototype._success=function(e){switch(e.success){case o.SocketSuccessType.Join:this.id=e.id}},e.prototype.send=function(e,n,t){return!!this.peers[e]&&(this.peers[e].send(n,t),!0)},e.prototype.broadcast=function(e,n){for(var t in this.peers)this.peers[t].send(e,n)},e.prototype.leave=function(e){delete this.peers[e]},e.prototype.login=function(e,n){this.socket.send({type:"login",credentials:{username:e,password:n}})},e.prototype.create=function(e,n){this.socket.send({type:"create",room:e,password:n})},e.prototype.connect=function(e,n){this.socket.send({type:"join",room:e,password:n})},e}();n.default=r},712:(e,n)=>{n.__esModule=!0;var t=function(){function e(e,n,t,o){var s=this;void 0===o&&(o=["default"]);var i={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"}]},r=null;(r=window.RTCPeerConnection?new RTCPeerConnection(i):new webkitRTCPeerConnection(i)).onicecandidate=function(n){n.candidate&&e({type:"candidate",candidate:n.candidate,target:s.remote})},r.onicegatheringstatechange=function(){console.log("ICE gathering state")},r.onicecandidateerror=function(e){return window.UNITY.error("ice",s.remote,e.errorText)},r.oniceconnectionstatechange=function(e){console.log("ICE state change",e)},r.onconnectionstatechange=this.ConnectionStateChange.bind(this),r.ondatachannel=this.onDataChannel.bind(this),this.remote=n,this.channelSchema=o,this.channels={},this.close=t,this.kill=this.kill.bind(this),this.connection=r}return e.prototype.kill=function(){var e;for(var n in this.channels)(null===(e=this.channels[n].channel)||void 0===e?void 0:e.close)instanceof Function&&this.channels[n].channel.close();this.connection.close(),window.UNITY.disconnect(this.remote),this.close(this.remote)},e.prototype.ConnectionStateChange=function(){switch(window.UNITY.connectionUpdate(this.remote,this.connection.connectionState),this.connection.connectionState){case"closed":case"disconnected":case"failed":this.kill()}},e.prototype.onDataChannel=function(e){var n=e.channel;this.setUpChannel(n)},e.prototype.setUpChannel=function(e){var n=this;e.onmessage=function(t){return n.onChannelMessage(e.label,t)},e.onerror=function(t){return n.onChannelError(e.label,t)},e.onopen=function(){return n.onChannelOpen(e.label)},e.onclose=function(t){return n.onChannelClose(e.label,t)},console.log("incomming channel:",e.label),this.channels[e.label]={channel:e,queue:[]}},e.prototype.createChannel=function(e){var n=this.connection.createDataChannel(e);this.setUpChannel(n)},e.prototype.onChannelOpen=function(e){if(this.channels[e].queue.length>0){console.log("rensing queue",e,this.channels[e].queue.length);for(var n=0,t=this.channels[e].queue;n<t.length;n++){var o=t[n];this.send(o,e)}this.channels[e].queue=[]}},e.prototype.onChannelClose=function(e,n){console.log("channel is closed",e,n.type),window.UNITY.channelUpdate(e,"closed")},e.prototype.onChannelMessage=function(e,n){window.UNITY.message(e,this.remote,n.data)},e.prototype.onChannelError=function(e,n){window.UNITY.error("channel",e,n.error.message)},e.prototype.createOffer=function(e,n){for(var t=this,o=0,s=this.channelSchema;o<s.length;o++){var i=s[o];this.createChannel(i)}return this.connection.createOffer().then((function(o){e({type:"offer",target:n,offer:o}),t.connection.setLocalDescription(o)})).catch((function(e){console.error("offer-error",e),alert("Error when creating an offer")}))},e.prototype.handleOffer=function(e,n){var t=this;return this.connection.setRemoteDescription(new RTCSessionDescription(n)),this.connection.createAnswer().then((function(n){t.connection.setLocalDescription(n),e({type:"answer",answer:n,target:t.remote})})).catch((function(e){console.error("answer-error",e),alert("Error when creating an answer")}))},e.prototype.handleAnswer=function(e){this.connection.setRemoteDescription(new RTCSessionDescription(e))},e.prototype.handleCandidate=function(e){this.connection.addIceCandidate(new RTCIceCandidate(e))},e.prototype.handleLeave=function(){this.connection.close(),this.connection.onicecandidate=null,this.close()},e.prototype.send=function(e,n){"string"==typeof n&&(n=[n]),n||(n=Object.keys(this.channels)),console.log("sending message",e,n);for(var t=0,o=n;t<o.length;t++){var s=o[t];"open"===this.channels[s].channel.readyState?this.channels[s].channel.send(e):this.channels[s].queue.push(e)}},e}();n.default=t},923:function(e,n){var t=this&&this.__assign||function(){return(t=Object.assign||function(e){for(var n,t=1,o=arguments.length;t<o;t++)for(var s in n=arguments[t])Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s]);return e}).apply(this,arguments)},o=this&&this.__rest||function(e,n){var t={};for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&n.indexOf(o)<0&&(t[o]=e[o]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var s=0;for(o=Object.getOwnPropertySymbols(e);s<o.length;s++)n.indexOf(o[s])<0&&Object.prototype.propertyIsEnumerable.call(e,o[s])&&(t[o[s]]=e[o[s]])}return t};n.__esModule=!0;var s=function(){function e(e){var n=this;this.token=null,this.events={},this.ws=new WebSocket(e),this.ws.onmessage=this.message.bind(this),this.on("success-login",(function(e){var t=e.token;n.token=t}))}return e.prototype.on=function(e,n){this.events[e]||(this.events[e]=new Array),this.events[e].push(n)},e.prototype.fire=function(e){for(var n=[],t=1;t<arguments.length;t++)n[t-1]=arguments[t];this.events[e]&&this.events[e].forEach((function(e){return e.apply(void 0,n)}))},e.prototype.send=function(e){var n=JSON.stringify(t(t({},e),{token:this.token}));this.ws.send(n)},e.prototype.error=function(e){var n=e.error,t=e.message;this.fire("error-"+n,t)},e.prototype.success=function(e){var n=e.success,t=e.message;this.fire("success-"+n,t)},e.prototype.message=function(e){var n=JSON.parse(e.data),t=n.type,s=o(n,["type"]);switch(this.events[t]&&this.fire(t,s),t){case"success":return this.success(s);case"error":return this.error(s);case"farwell":console.log("[SOCKET] Goodbye, thats it! out and fly child!"),this.ws.close()}},e}();n.default=s},570:e=>{e.exports=2}},t={};e=function e(o){if(t[o])return t[o].exports;var s=t[o]={exports:{}};return n[o].call(s.exports,s,s.exports,e),s.exports}(190),window.RTC=new e.default,window.UNITY={connectionUpdate:function(e,n){console.log("state update",e,n)},message:function(e,n,t){console.log("new message from "+n+" on "+e+": "+t)},error:function(e,n,t){console.log("oh no, error!",n,e,t)},channelUpdate:function(e,n){console.log("new update for channel",e,n)},disconnect:function(e){console.log("peer disonnect",e)}}})();